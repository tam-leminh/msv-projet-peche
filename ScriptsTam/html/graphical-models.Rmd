---
title: "Modèles graphiques"
author: "tlm"
date: "17/12/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(glasso)
library(qgraph)
library(Matrix)
library(sfsmisc)
library(huge)
```

## Chargement des données

```{r message=FALSE, results='hide'}
source("miseenformedonnees.R")
```

## Préparation des données

Calcul de $\Sigma$ la matrice de covariance de $Z = (X_k, Y_k, k = 1,..,K)$.

On approche $\Sigma$ par $S$ définie positive.

```{r}
lan = lanquant.co[c(8:157)]
dis = disquant.co[c(8:157)]
colnames(lan) = paste0("X",c(1:150))
colnames(dis) = paste0("Y",c(1:150))
nodes = data.frame(lan, dis)
nonzero = which(colSums(nodes)!=0)
nodes = subset(nodes, select=c(nonzero))
sigma = cov(nodes, nodes)
names = rownames(sigma)
s = posdefify(sigma)
colnames(s) = names
rownames(s) = names
```

## Modèle graphique gaussien

### Graphical-Lasso

Graphe complet : 

```{r}
a <- glasso(s, rho=10000000, nobs=362)
qgraph(a, labels=names, layout="spring")
```

En enlevant les noeuds isolés :

```{r}
a_ndiag = a$w
diag(a_ndiag) = 0
a_non <- which(colSums(a_ndiag)!=0)
a_non_names <- names[a_non]
a_simple <- a_ndiag[a_non, a_non]
qgraph(a_simple, labels=a_non_names, layout="spring")
```

### Sélection avec critère BIC

Graphe complet : 

```{r warning=FALSE}
b <- EBICglasso(s, n=362, gamma=0, threshold=TRUE)
qgraph(b, layout="spring")
```

En enlevant les noeuds isolés :

```{r}
b_non <- which(colSums(b)!=0)
b_non_names <- names[b_non]
b_simple <- b[b_non, b_non]
qgraph(b_simple, labels=b_non_names, layout="spring")
```

### Sélection avec EBIC

Graphe complet : 

```{r warning=FALSE}
e <- EBICglasso(s, n=362, gamma=0.5, threshold=TRUE)
qgraph(e, layout="spring")
```

En enlevant les noeuds isolés :

```{r}
e_non <- which(colSums(e)!=0)
e_non_names <- names[e_non]
e_simple <- e[e_non, e_non]
qgraph(e_simple, labels=e_non_names, layout="spring")
```

## GGM + Copules

On trouve une transformation des variables initiales en variables gaussiennes avec un estimateur non-paramétrique, puis on suppose que les nouvelles variables forment un vecteur gaussien. 

### Correlation threshold

```{r warning=FALSE, message=FALSE, results='hide'}
s.npn <- huge.npn(s)
h <- huge(s.npn, method="ct")
plot(h)
```

### Graphical-Lasso

```{r warning=FALSE, message=FALSE, results='hide'}
s.npn <- huge.npn(s)
h <- huge(s.npn, method="glasso")
plot(h)
```

### Meinshausen-Bühlmann

```{r warning=FALSE, message=FALSE, results='hide'}
s.npn <- huge.npn(s)
h <- huge(s.npn, method="mb")
plot(h)
```